trigger:
  batch: true
  branches:
    include:
      - 'master'

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

steps:
- task: DotNetCoreCLI@2
  displayName: "Build Package with CI version"
  inputs:
    command: build
    projects: src/FooLib/FooLib.csproj
    configuration: $(buildConfiguration)
    workingDirectory: $(Build.SourcesDirectory)
    arguments: --version-suffix ci+$(Build.BuildId).$(Build.SourceVersion)
- task: DotNetCoreCLI@2
  displayName: "Pack Nuget package"
  inputs:
    command: pack
    projects: src/FooLib/FooLib.csproj
    configuration: $(buildConfiguration)
    workingDirectory: $(Build.SourcesDirectory)
    nobuild: true
    outputDir: '$(Build.ArtifactStagingDirectory)/packages/pipeline'
- task: NuGetCommand@2
  displayName: "Publish CI Package to Azure Artifacts"
  inputs:
    command: push
    publishVstsFeed: FooLib
    packagesToPush: $(Build.ArtifactStagingDirectory)/**/*-ci+*.nupkg
- task: DotNetCoreCLI@2
  displayName: "Execute Unit Tests"
  inputs:
    command: test
    projects: test/FooLibTests/FooLibTests.csproj
    configuration: $(buildConfiguration)
    arguments: >
      --no-build 
      --verbosity normal
    publishTestResults: true
    workingDirectory: $(Build.SourcesDirectory)
