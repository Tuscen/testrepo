trigger:
  batch: true
  branches:
    include:
      - 'master'

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

steps:
- task: UseDotNet@2
  displayName: Install .NET Core 3.1 SDK
  inputs:
   version: 3.1.100
   packageType: sdk
- task: DotNetCoreCLI@2
  displayName: "Build Package with CI version"
  inputs:
    command: build
    projects: src/FooLib/FooLib.csproj
    # configuration: $(buildConfiguration)
    # buildProperties: VersionSuffix="ci.$(Build.BuildId)+git.commit.$(Build.SourceVersion)"
    arguments: >
      --configuration $(buildConfiguration)
      --version-suffix "ci.$(Build.BuildId)+git.commit.$(Build.SourceVersion)"
- publish: 
  artifact: linux-build
- task: DotNetCoreCLI@2
  displayName: "Pack Nuget package"
  inputs:
    command: pack
    projects: src/FooLib/FooLib.csproj
    # configuration: $(buildConfiguration)
    outputDir: $(Build.ArtifactStagingDirectory)/packages/ci
    arguments: >
      --configuration $(buildConfiguration)
- task: NuGetCommand@2
  displayName: "Publish CI Package to Azure Artifacts"
  inputs:
    command: push
    publishVstsFeed: FooLib
    packagesToPush: $(Build.ArtifactStagingDirectory)/**/*-ci.nupkg
- task: DotNetCoreCLI@2
  displayName: "Execute Unit Tests"
  inputs:
    command: test
    projects: test/FooLibTests/FooLibTests.csproj
    configuration: $(buildConfiguration)
    arguments: >
      --verbosity normal
      --configuration $(buildConfiguration)
    publishTestResults: true
    workingDirectory: $(Build.SourcesDirectory)
